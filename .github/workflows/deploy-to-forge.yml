name: Build and Deploy to Forge

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    env:
      VITE_GA_MEASUREMENT_ID: ${{ secrets.VITE_GA_MEASUREMENT_ID }}
      VITE_FACEBOOK_PIXEL_ID: ${{ secrets.VITE_FACEBOOK_PIXEL_ID }}
      VITE_CLARITY_ID: ${{ secrets.VITE_CLARITY_ID }}
      VITE_BREVO_LIST_FREELANCERS: ${{ secrets.VITE_BREVO_LIST_FREELANCERS }}
      VITE_BREVO_LIST_EMPRESAS: ${{ secrets.VITE_BREVO_LIST_EMPRESAS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Use Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: npm ci

      - name: Build client
        run: npm run build:client

      - name: Include PHP API endpoints
        run: |
          mkdir -p dist/public/api
          cp -R public/api/. dist/public/api/

      - name: Prepare SSH
        uses: webfactory/ssh-agent@v0.8.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Ensure known hosts (optional)
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy `dist/public` to Forge server via rsync
        uses: burnett01/rsync-deploy@v4.0.4
        with:
          switches: -azP --delete
          path: dist/public/
          remote_path: ${{ secrets.TARGET_DIR }}
          remote_host: ${{ secrets.SSH_HOST }}
          remote_user: ${{ secrets.SSH_USERNAME }}
          remote_port: ${{ secrets.SSH_PORT }}
          private_key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Fix permissions (optional)
        run: ssh -o StrictHostKeyChecking=no -p ${{ secrets.SSH_PORT }} ${{ secrets.SSH_USERNAME }}@${{ secrets.SSH_HOST }} "chown -R forge:forge ${{ secrets.TARGET_DIR }} || true"
